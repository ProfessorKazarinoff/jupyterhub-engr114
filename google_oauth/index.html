



<!DOCTYPE html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <meta http-equiv="x-ua-compatible" content="ie=edge">
      
      
      
      
        <meta name="lang:clipboard.copy" content="Copy to clipboard">
      
        <meta name="lang:clipboard.copied" content="Copied to clipboard">
      
        <meta name="lang:search.language" content="en">
      
        <meta name="lang:search.pipeline.stopwords" content="True">
      
        <meta name="lang:search.pipeline.trimmer" content="True">
      
        <meta name="lang:search.result.none" content="No matching documents">
      
        <meta name="lang:search.result.one" content="1 matching document">
      
        <meta name="lang:search.result.other" content="# matching documents">
      
        <meta name="lang:search.tokenizer" content="[\s\-]+">
      
      <link rel="shortcut icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.0.4, mkdocs-material-3.0.6">
    
    
      
        <title>Google OAuth - ENGR114-JupyterHub-Deployment</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/application.451f80e5.css">
      
        <link rel="stylesheet" href="../assets/stylesheets/application-palette.22915126.css">
      
      
        
        
        <meta name="theme-color" content="#ff7043">
      
    
    
      <script src="../assets/javascripts/modernizr.1aa3b519.js"></script>
    
    
      
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700|Roboto+Mono">
        <style>body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}</style>
      
    
    <link rel="stylesheet" href="../assets/fonts/material-icons.css">
    
      <link rel="stylesheet" href="../static/css/toc.css">
    
    
  </head>
  
    
    
    <body dir="ltr" data-md-color-primary="deep-orange" data-md-color-accent="indigo">
  
    <svg class="md-svg">
      <defs>
        
        
          <svg xmlns="http://www.w3.org/2000/svg" width="416" height="448"
    viewBox="0 0 416 448" id="__github">
  <path fill="currentColor" d="M160 304q0 10-3.125 20.5t-10.75 19-18.125
        8.5-18.125-8.5-10.75-19-3.125-20.5 3.125-20.5 10.75-19 18.125-8.5
        18.125 8.5 10.75 19 3.125 20.5zM320 304q0 10-3.125 20.5t-10.75
        19-18.125 8.5-18.125-8.5-10.75-19-3.125-20.5 3.125-20.5 10.75-19
        18.125-8.5 18.125 8.5 10.75 19 3.125 20.5zM360
        304q0-30-17.25-51t-46.75-21q-10.25 0-48.75 5.25-17.75 2.75-39.25
        2.75t-39.25-2.75q-38-5.25-48.75-5.25-29.5 0-46.75 21t-17.25 51q0 22 8
        38.375t20.25 25.75 30.5 15 35 7.375 37.25 1.75h42q20.5 0
        37.25-1.75t35-7.375 30.5-15 20.25-25.75 8-38.375zM416 260q0 51.75-15.25
        82.75-9.5 19.25-26.375 33.25t-35.25 21.5-42.5 11.875-42.875 5.5-41.75
        1.125q-19.5 0-35.5-0.75t-36.875-3.125-38.125-7.5-34.25-12.875-30.25-20.25-21.5-28.75q-15.5-30.75-15.5-82.75
        0-59.25 34-99-6.75-20.5-6.75-42.5 0-29 12.75-54.5 27 0 47.5 9.875t47.25
        30.875q36.75-8.75 77.25-8.75 37 0 70 8 26.25-20.5
        46.75-30.25t47.25-9.75q12.75 25.5 12.75 54.5 0 21.75-6.75 42 34 40 34
        99.5z" />
</svg>
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
    
      <a href="#google-authentication" tabindex="1" class="md-skip">
        Skip to content
      </a>
    
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href=".." title="ENGR114-JupyterHub-Deployment" class="md-header-nav__button md-logo">
          
            <i class="md-icon">build</i>
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
          
            
              <span class="md-header-nav__topic">
                ENGR114-JupyterHub-Deployment
              </span>
              <span class="md-header-nav__topic">
                Google OAuth
              </span>
            
          
        </div>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        
          
            <label class="md-icon md-icon--search md-header-nav__button" for="__search"></label>
            
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active">
      <label class="md-icon md-search__icon" for="__search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">
        &#xE5CD;
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
          
        
      </div>
      
        <div class="md-flex__cell md-flex__cell--shrink">
          <div class="md-header-nav__source">
            


  


  <a href="https://github.com/ProfessorKazarinoff/jupyterhub-engr114/" title="Go to repository" class="md-source" data-md-source="github">
    
      <div class="md-source__icon">
        <svg viewBox="0 0 24 24" width="24" height="24">
          <use xlink:href="#__github" width="24" height="24"></use>
        </svg>
      </div>
    
    <div class="md-source__repository">
      GitHub
    </div>
  </a>

          </div>
        </div>
      
    </div>
  </nav>
</header>
    
    <div class="md-container">
      
        
      
      
      <main class="md-main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="__drawer">
    <a href=".." title="ENGR114-JupyterHub-Deployment" class="md-nav__button md-logo">
      
        <i class="md-icon">build</i>
      
    </a>
    ENGR114-JupyterHub-Deployment
  </label>
  
    <div class="md-nav__source">
      


  


  <a href="https://github.com/ProfessorKazarinoff/jupyterhub-engr114/" title="Go to repository" class="md-source" data-md-source="github">
    
      <div class="md-source__icon">
        <svg viewBox="0 0 24 24" width="24" height="24">
          <use xlink:href="#__github" width="24" height="24"></use>
        </svg>
      </div>
    
    <div class="md-source__repository">
      GitHub
    </div>
  </a>

    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href=".." title="Home" class="md-nav__link">
      Home
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../setup/" title="Set Up" class="md-nav__link">
      Set Up
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../doserver/" title="DO server" class="md-nav__link">
      DO server
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../install_jupyterhub/" title="Install JupyterHub" class="md-nav__link">
      Install JupyterHub
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../DNS/" title="DNS Routing" class="md-nav__link">
      DNS Routing
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../ssl/" title="SSL Certificates" class="md-nav__link">
      SSL Certificates
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../cookie_secret_proxy_auth_token/" title="Cookie Secret and Proxy Auth Token" class="md-nav__link">
      Cookie Secret and Proxy Auth Token
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../nginx_install/" title="Install Nginx" class="md-nav__link">
      Install Nginx
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../nginx_config/" title="Nginx Configuration" class="md-nav__link">
      Nginx Configuration
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../jupyterhub_config/" title="JupyterHub Configuration" class="md-nav__link">
      JupyterHub Configuration
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../systemd/" title="System Service" class="md-nav__link">
      System Service
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../github_oauth/" title="GitHub OAuth" class="md-nav__link">
      GitHub OAuth
    </a>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-toggle md-nav__toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    
      
    
    
      <label class="md-nav__link md-nav__link--active" for="__toc">
        Google OAuth
      </label>
    
    <a href="./" title="Google OAuth" class="md-nav__link md-nav__link--active">
      Google OAuth
    </a>
    
      
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#google-oauth-instance" title="Google OAuth Instance" class="md-nav__link">
    Google OAuth Instance
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#modify-jupyterhub_configpy" title="Modify jupyterhub_config.py" class="md-nav__link">
    Modify jupyterhub_config.py
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#restart-jupyterhub-and-login" title="Restart JupyterHub and Login" class="md-nav__link">
    Restart JupyterHub and Login
  </a>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
    
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../jupyterlab_default/" title="JupyterLab Default Interface" class="md-nav__link">
      JupyterLab Default Interface
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../login_page/" title="Custom Login Page" class="md-nav__link">
      Custom Login Page
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../github_assignments/" title="Assignments from GitHub" class="md-nav__link">
      Assignments from GitHub
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../useful_commands/" title="Usefull Commands" class="md-nav__link">
      Usefull Commands
    </a>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#google-oauth-instance" title="Google OAuth Instance" class="md-nav__link">
    Google OAuth Instance
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#modify-jupyterhub_configpy" title="Modify jupyterhub_config.py" class="md-nav__link">
    Modify jupyterhub_config.py
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#restart-jupyterhub-and-login" title="Restart JupyterHub and Login" class="md-nav__link">
    Restart JupyterHub and Login
  </a>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                  <a href="https://github.com/ProfessorKazarinoff/jupyterhub-engr114/edit/master/docs/google_oauth.md" title="Edit this page" class="md-icon md-content__icon">&#xE3C9;</a>
                
                
                <h1 id="google-authentication">Google Authentication</h1>
<p>Now that the GitHub authenticator works, we are going to get into the weeds of getting the Google authenticator to work. </p>
<p>Why Google authenticator instead of GitHub? Our college uses the gmail suite for both staff and students. When students log onto their college email, they are logging into gmail. Students can use Google calendar and Google drive with their college email account as well. So it is probably best that students log into JuypterHub using the same Google login that they use to access their college email, Google drive and calendar. </p>
<div class="toc">
<ul>
<li><a href="#google-authentication">Google Authentication</a><ul>
<li><a href="#google-oauth-instance">Google OAuth Instance</a></li>
<li><a href="#modify-jupyterhub_configpy">Modify jupyterhub_config.py</a></li>
<li><a href="#restart-jupyterhub-and-login">Restart JupyterHub and Login</a></li>
</ul>
</li>
</ul>
</div>
<h2 id="google-oauth-instance">Google OAuth Instance</h2>
<p>To allow students to use Google usernames and passwords to log into JupyterHub, the first thing we need to do is set up a Google OAuth instance. I set up Google OAuth instance using my personal gmail account, rather than my college gmail account. Some parts of Google suite are not available in my college profile, like YouTube and developer tabs. </p>
<p>To obtain the Google OAuth credentials, we need to log into the Google API console <a href="https://console.developers.google.com/">https://console.developers.google.com/</a> and select [Credentials] on the lefthand menu.</p>
<p><img alt="Google oauth credentials" src="../images/google_oauth_credentials.png" /></p>
<p>Next we'll create a new OAuth credential under [Credentials] --&gt; [Create Credentials] --&gt; [OAuth client ID]:</p>
<p><img alt="Google create credentials" src="../images/google_oauth_create_credentials.png" /></p>
<p>To create a set of Google OAuth credentials we need to input:</p>
<ul>
<li>Authorized JavaScript origins: <code>https://mydomain.org</code></li>
<li>Authorized redirect URIs: <code>https://mydomain.org/hub/oauth_callback</code></li>
</ul>
<p><img alt="Google js origins and callback url" src="../images/google_oauth_javascript_origins_redirect_uri.png" /></p>
<p>After creating a new set of Google OAuth credentials, note the:</p>
<ul>
<li>client ID</li>
<li>client secret</li>
</ul>
<p><img alt="Google client ID and secret" src="../images/google_oauth_client_id_and_secret.png" /></p>
<p>The client ID and client secret strings will be included in our revised JupyterHub configuration.</p>
<h2 id="modify-jupyterhub_configpy">Modify jupyterhub_config.py</h2>
<p>Once we get our Google OAuth credentials, we need to edit <code>jupyterhub_conf.py</code> again. Note your Google OAuth credentials need to replace <code>'XXXXXXXXXXXXXXXXX'</code>. </p>
<pre><code class="python"># /etc/jupyterhub/jupyterhub_conf.py

# For Google OAuth
from oauthenticator.google import LocalGoogleOAuthenticator
c.JupyterHub.authenticator_class = LocalGoogleOAuthenticator

# Set up config
c = get_config()
c.JupyterHub.log_level = 10
c.Spawner.cmd = '/opt/miniconda3/envs/jupyterhubenv/bin/jupyterhub-singleuser'

# Cookie Secret and Proxy Auth Token Files
c.JupyterHub.cookie_secret_file = '/srv/jupyterhub/jupyterhub_cookie_secret'
c.ConfigurableHTTPProxy.auth_token = '/srv/jupyterhub/proxy_auth_token'

# Google OAuth Login - Seems to work 2018-11-01
c.LocalGoogleOAuthenticator.oauth_callback_url = 'https://mydomain.org/hub/oauth_callback'
c.LocalGoogleOAuthenticator.client_id = 'XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX'
c.LocalGoogleOAuthenticator.client_secret = 'XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX'
c.LocalGoogleOAuthenticator.create_system_users = True
c.Authenticator.add_user_cmd = ['adduser', '-q', '--gecos', '&quot;&quot;', '--disabled-password', '--force-badname']
c.LocalGoogleOAuthenticator.hosted_domain = 'college.edu'
c.LocalGoogleOAuthenticator.login_service = 'College Name'

</code></pre>

<p>This little line:</p>
<pre><code class="python">c.Authenticator.add_user_cmd = ['adduser', '-q', '--gecos', '&quot;&quot;', '--disabled-password', '--force-badname']
</code></pre>

<p>was a real gottacha. Our college email addresses are in the form:</p>
<p><code>firstname.lastname@college.edu</code></p>
<p>When a student logs in, JupyterHub tries to create a new Linux user with a dot <code>.</code> in their username. Usernames with <code>.</code> doesn't work on Linux. I tried to create a new Linux user with a dot in their username, and the terminal asked me to use the <code>--force-badname</code> flag. So <code>--force-badname</code> is what we'll add to the <code>c.Authenticator.add_user_cmd</code> list. Otherwise, users (students) will be able to authenticate with Google, but they won't get a new user account on the server, and they won't be able to run notebooks or Python code.</p>
<h2 id="restart-jupyterhub-and-login">Restart JupyterHub and Login</h2>
<p>Restart JupyterHub and browse to the web address attached to the server.</p>
<pre><code>$ sudo systemctl stop jupyterhub
$ sudo systemctl start jupyterhub
$ sudo systemctl status jupyterhub
# [Ctrl + c] to exit
</code></pre>

<p>The login window should now look something like:</p>
<p><img alt="Sign in with Google" src="../images/sign_in_with_google.PNG" /></p>
<p>We can log in with our Google user name and password (college username and password). </p>
<p>Pretty sweet!</p>
<p>After we log in using our college username and password, we can see if JupyterHub created a new user (with our college username) on the server. The command below produces a long list of users. This long list contains the non-root sudo user <code>peter</code> and the Google authenticated user (college username).</p>
<pre><code class="text">$ awk -F':' '{ print $1}' /etc/passwd
....
uuidd
dnsmasq
landscape
sshd
pollinate
peter
peter.lastname
githubusername
</code></pre>

<p><br></p>
                
                  
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">
        
          <a href="../github_oauth/" title="GitHub OAuth" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
            </div>
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                GitHub OAuth
              </span>
            </div>
          </a>
        
        
          <a href="../jupyterlab_default/" title="JupyterLab Default Interface" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                JupyterLab Default Interface
              </span>
            </div>
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
          <div class="md-footer-copyright__highlight">
            Copyright &copy; 2018 Peter D. Kazarinoff
          </div>
        
        powered by
        <a href="https://www.mkdocs.org">MkDocs</a>
        and
        <a href="https://squidfunk.github.io/mkdocs-material/">
          Material for MkDocs</a>
      </div>
      
        
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../assets/javascripts/application.5e60981f.js"></script>
      
      <script>app.initialize({version:"1.0.4",url:{base:".."}})</script>
      
    
    
      
    
  </body>
</html>