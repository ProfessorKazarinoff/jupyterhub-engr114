



<!DOCTYPE html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <meta http-equiv="x-ua-compatible" content="ie=edge">
      
      
      
      
        <meta name="lang:clipboard.copy" content="Copy to clipboard">
      
        <meta name="lang:clipboard.copied" content="Copied to clipboard">
      
        <meta name="lang:search.language" content="en">
      
        <meta name="lang:search.pipeline.stopwords" content="True">
      
        <meta name="lang:search.pipeline.trimmer" content="True">
      
        <meta name="lang:search.result.none" content="No matching documents">
      
        <meta name="lang:search.result.one" content="1 matching document">
      
        <meta name="lang:search.result.other" content="# matching documents">
      
        <meta name="lang:search.tokenizer" content="[\s\-]+">
      
      <link rel="shortcut icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.0.4, mkdocs-material-3.0.6">
    
    
      
        <title>Assignments from GitHub - ENGR114-JupyterHub-Deployment</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/application.451f80e5.css">
      
        <link rel="stylesheet" href="../assets/stylesheets/application-palette.22915126.css">
      
      
        
        
        <meta name="theme-color" content="#ff7043">
      
    
    
      <script src="../assets/javascripts/modernizr.1aa3b519.js"></script>
    
    
      
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700|Roboto+Mono">
        <style>body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}</style>
      
    
    <link rel="stylesheet" href="../assets/fonts/material-icons.css">
    
      <link rel="stylesheet" href="../static/css/toc.css">
    
    
  </head>
  
    
    
    <body dir="ltr" data-md-color-primary="deep-orange" data-md-color-accent="indigo">
  
    <svg class="md-svg">
      <defs>
        
        
          <svg xmlns="http://www.w3.org/2000/svg" width="416" height="448"
    viewBox="0 0 416 448" id="__github">
  <path fill="currentColor" d="M160 304q0 10-3.125 20.5t-10.75 19-18.125
        8.5-18.125-8.5-10.75-19-3.125-20.5 3.125-20.5 10.75-19 18.125-8.5
        18.125 8.5 10.75 19 3.125 20.5zM320 304q0 10-3.125 20.5t-10.75
        19-18.125 8.5-18.125-8.5-10.75-19-3.125-20.5 3.125-20.5 10.75-19
        18.125-8.5 18.125 8.5 10.75 19 3.125 20.5zM360
        304q0-30-17.25-51t-46.75-21q-10.25 0-48.75 5.25-17.75 2.75-39.25
        2.75t-39.25-2.75q-38-5.25-48.75-5.25-29.5 0-46.75 21t-17.25 51q0 22 8
        38.375t20.25 25.75 30.5 15 35 7.375 37.25 1.75h42q20.5 0
        37.25-1.75t35-7.375 30.5-15 20.25-25.75 8-38.375zM416 260q0 51.75-15.25
        82.75-9.5 19.25-26.375 33.25t-35.25 21.5-42.5 11.875-42.875 5.5-41.75
        1.125q-19.5 0-35.5-0.75t-36.875-3.125-38.125-7.5-34.25-12.875-30.25-20.25-21.5-28.75q-15.5-30.75-15.5-82.75
        0-59.25 34-99-6.75-20.5-6.75-42.5 0-29 12.75-54.5 27 0 47.5 9.875t47.25
        30.875q36.75-8.75 77.25-8.75 37 0 70 8 26.25-20.5
        46.75-30.25t47.25-9.75q12.75 25.5 12.75 54.5 0 21.75-6.75 42 34 40 34
        99.5z" />
</svg>
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
    
      <a href="#assignments-from-github" tabindex="1" class="md-skip">
        Skip to content
      </a>
    
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href=".." title="ENGR114-JupyterHub-Deployment" class="md-header-nav__button md-logo">
          
            <i class="md-icon">build</i>
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
          
            
              <span class="md-header-nav__topic">
                ENGR114-JupyterHub-Deployment
              </span>
              <span class="md-header-nav__topic">
                Assignments from GitHub
              </span>
            
          
        </div>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        
          
            <label class="md-icon md-icon--search md-header-nav__button" for="__search"></label>
            
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active">
      <label class="md-icon md-search__icon" for="__search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">
        &#xE5CD;
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
          
        
      </div>
      
        <div class="md-flex__cell md-flex__cell--shrink">
          <div class="md-header-nav__source">
            


  


  <a href="https://github.com/ProfessorKazarinoff/jupyterhub-engr114/" title="Go to repository" class="md-source" data-md-source="github">
    
      <div class="md-source__icon">
        <svg viewBox="0 0 24 24" width="24" height="24">
          <use xlink:href="#__github" width="24" height="24"></use>
        </svg>
      </div>
    
    <div class="md-source__repository">
      GitHub
    </div>
  </a>

          </div>
        </div>
      
    </div>
  </nav>
</header>
    
    <div class="md-container">
      
        
      
      
      <main class="md-main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="__drawer">
    <a href=".." title="ENGR114-JupyterHub-Deployment" class="md-nav__button md-logo">
      
        <i class="md-icon">build</i>
      
    </a>
    ENGR114-JupyterHub-Deployment
  </label>
  
    <div class="md-nav__source">
      


  


  <a href="https://github.com/ProfessorKazarinoff/jupyterhub-engr114/" title="Go to repository" class="md-source" data-md-source="github">
    
      <div class="md-source__icon">
        <svg viewBox="0 0 24 24" width="24" height="24">
          <use xlink:href="#__github" width="24" height="24"></use>
        </svg>
      </div>
    
    <div class="md-source__repository">
      GitHub
    </div>
  </a>

    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href=".." title="Home" class="md-nav__link">
      Home
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../setup/" title="Set Up" class="md-nav__link">
      Set Up
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../doserver/" title="DO server" class="md-nav__link">
      DO server
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../install_jupyterhub/" title="Install JupyterHub" class="md-nav__link">
      Install JupyterHub
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../DNS/" title="DNS Routing" class="md-nav__link">
      DNS Routing
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../ssl/" title="SSL Certificates" class="md-nav__link">
      SSL Certificates
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../cookie_secret_proxy_auth_token/" title="Cookie Secret and Proxy Auth Token" class="md-nav__link">
      Cookie Secret and Proxy Auth Token
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../nginx_install/" title="Install Nginx" class="md-nav__link">
      Install Nginx
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../nginx_config/" title="Nginx Configuration" class="md-nav__link">
      Nginx Configuration
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../jupyterhub_config/" title="JupyterHub Configuration" class="md-nav__link">
      JupyterHub Configuration
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../systemd/" title="System Service" class="md-nav__link">
      System Service
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../github_oauth/" title="GitHub OAuth" class="md-nav__link">
      GitHub OAuth
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../google_oauth/" title="Google OAuth" class="md-nav__link">
      Google OAuth
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../jupyterlab_default/" title="JupyterLab Default Interface" class="md-nav__link">
      JupyterLab Default Interface
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../login_page/" title="Custom Login Page" class="md-nav__link">
      Custom Login Page
    </a>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-toggle md-nav__toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    
      
    
    
      <label class="md-nav__link md-nav__link--active" for="__toc">
        Assignments from GitHub
      </label>
    
    <a href="./" title="Assignments from GitHub" class="md-nav__link md-nav__link--active">
      Assignments from GitHub
    </a>
    
      
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#create-a-repo-of-assignments-on-githubcom" title="Create a repo of assignments on github.com" class="md-nav__link">
    Create a repo of assignments on github.com
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#install-gitpython" title="Install gitpython" class="md-nav__link">
    Install gitpython
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#git-clone-function" title="Git clone function" class="md-nav__link">
    Git clone function
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#create-pre-spawn-hook" title="Create pre-spawn hook" class="md-nav__link">
    Create pre-spawn hook
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#add-pre-spawn-hook-to-jupyterhub_configpy" title="Add pre-spawn hook to jupyterhub_config.py" class="md-nav__link">
    Add pre-spawn hook to jupyterhub_config.py
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#restart-jupyterhub" title="Restart JupyterHub" class="md-nav__link">
    Restart JupyterHub
  </a>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
    
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../useful_commands/" title="Usefull Commands" class="md-nav__link">
      Usefull Commands
    </a>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#create-a-repo-of-assignments-on-githubcom" title="Create a repo of assignments on github.com" class="md-nav__link">
    Create a repo of assignments on github.com
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#install-gitpython" title="Install gitpython" class="md-nav__link">
    Install gitpython
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#git-clone-function" title="Git clone function" class="md-nav__link">
    Git clone function
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#create-pre-spawn-hook" title="Create pre-spawn hook" class="md-nav__link">
    Create pre-spawn hook
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#add-pre-spawn-hook-to-jupyterhub_configpy" title="Add pre-spawn hook to jupyterhub_config.py" class="md-nav__link">
    Add pre-spawn hook to jupyterhub_config.py
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#restart-jupyterhub" title="Restart JupyterHub" class="md-nav__link">
    Restart JupyterHub
  </a>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                  <a href="https://github.com/ProfessorKazarinoff/jupyterhub-engr114/edit/master/docs/github_assignments.md" title="Edit this page" class="md-icon md-content__icon">&#xE3C9;</a>
                
                
                <h1 id="assignments-from-github">Assignments from GitHub</h1>
<p>Now we'll build a pre-spawn hook that creates an "assignments" and "notes" directory with pre-constructed assignments and notes for each JupyterHub user.</p>
<div class="toc">
<ul>
<li><a href="#assignments-from-github">Assignments from GitHub</a><ul>
<li><a href="#create-a-repo-of-assignments-on-githubcom">Create a repo of assignments on github.com</a></li>
<li><a href="#install-gitpython">Install gitpython</a></li>
<li><a href="#git-clone-function">Git clone function</a></li>
<li><a href="#create-pre-spawn-hook">Create pre-spawn hook</a></li>
<li><a href="#add-pre-spawn-hook-to-jupyterhub_configpy">Add pre-spawn hook to jupyterhub_config.py</a></li>
<li><a href="#restart-jupyterhub">Restart JupyterHub</a></li>
</ul>
</li>
</ul>
</div>
<h2 id="create-a-repo-of-assignments-on-githubcom">Create a repo of assignments on github.com</h2>
<p>On github.com, create a new repo with the notes and assignments for the quarter.</p>
<p><img alt="new repo" src="../images/new_github_repo.png" /></p>
<p><img alt="repo details" src="../images/new_repo_details.png" /></p>
<p>On a local computer, not the server, clone the GitHub repo. This allows us to work on the notes and assignments locally.</p>
<pre><code># local computer
$ mkdir ENGR101
$ cd ENGR101
$ git init
$ git remote add origin https://github.com/username/reponame.git
$ git pull origin master
</code></pre>

<p>On the local computer, not the server, build the assignment and notes for the quarter. I did this using Jupyter notebooks. Then add, commit and push the changes up to GitHub.</p>
<pre><code># local computer
$ git add .
$ commit -m &quot;added assignments and notes&quot;
$ git push origin master
</code></pre>

<p><br></p>
<h2 id="install-gitpython">Install gitpython</h2>
<p>Now we can go to the server and have the notebooks we created (and pushed up to GitHub) pre-populate each user's directory tree when they log into JupyterHub.</p>
<p>We'll use a Python package called <strong>gitpython</strong> to help with pulling the notebooks down from github.com. Log into the server and install <strong>gitpython</strong> using <strong>conda</strong>:</p>
<pre><code># on the server
$ sudo apt-get update
$ conda install -c conda-forge gitpython
</code></pre>

<p>Now we need to modify the <code>jupyterhub_config.py</code> file to do a couple things:</p>
<ul>
<li>Run a pre-spawn hook function that runs before each user's Jupyter notebook server is started</li>
<li>Pull the assignments and notes down from GitHub as part of the pre-spawn hook function.</li>
</ul>
<p>The pre-spawn hook function gets called every time a user logs into JupyterHub.  This pre-spawn hook will run before the user's Jupyter notebook server is created. In the pre-spawn hook, we want to check to see if the user has the assignments and notes pulled down from GitHub already loaded. If the user doesn't have the assignments, then we want to pull the assignments down from GitHub and put them in the user's directory tree.</p>
<h2 id="git-clone-function">Git clone function</h2>
<p>So first we need a function that will pull the repo down from GitHub. Note the line <code>uid = getpwnam(user).pw_uid</code> and <code>gid = getpwnam(user).pw_gid</code> in the function below. These lines of code get the user's numerical unix user ID and group ID. The user ID and group ID are needed to assign the proper permissions to the files we pull down from GitHub.</p>
<p>When I first built the function, changing file permissions was not included. I could log onto JupterHub and see the notebooks pulled down from GitHub, but I couldn't run or edit them. The problem was that the notebooks were pulled down from GitHub by a <strong>sudo user</strong> and the JupyterHub user didn't have the permissions to write or execute any of the files. Building the permissions into the function with <code>shutil.chown()</code> solved the problem.</p>
<pre><code class="python"># in jupyterhub_config.py

def clone_repo(user, git_url, repo_dir):
    &quot;&quot;&quot;
    A function to clone a github repo into a specific directory of a user.
    &quot;&quot;&quot;
    Repo.clone_from(git_url, repo_dir)
    uid = getpwnam(user).pw_uid
    gid = getpwnam(user).pw_gid
    for root, dirs, files in os.walk(repo_dir):
        for d in dirs:
            shutil.chown(os.path.join(root, d), user=uid, group=gid)
        for f in files:
            shutil.chown(os.path.join(root, f), user=uid, group=gid)
</code></pre>

<h2 id="create-pre-spawn-hook">Create pre-spawn hook</h2>
<p>Now we'll build a pre-spawn hook function that will run when the spawner starts. The function will call the <code>clone_repo()</code> function and pull down the assignments from the github repo the first time a user logs into JupyterHub.  After the assignments and notes are initially created, each subsequent time the user logs into JupyterHub, a new fresh set of assignments and notes are pulled down if <code>ERASE_DIR</code> is set to <code>True</code>. If <code>ERASE_DIR</code> is set to <code>False</code>, once the assignments and notes are downloaded, they will not be over-written.</p>
<p>To run the pre-spawn hook function and the pull repo function, we need to make sure the following imports are present in our jupyterhub_config.py file:</p>
<pre><code class="python"># /etc/jupyterhub/jupyterhub_config.py

import git, os, shutil
from pwd import getpwnam
</code></pre>

<p>The complete pre-spawn hook function is below:</p>
<pre><code class="python"># /etc/jupyterhub/jupyterhub_config.py

...

def create_dir_hook(spawner):
    &quot;&quot;&quot;
    A function to clone a github repo into a specific directory of a 
   JupyterHub user when the server spawns a new notebook instance.
    &quot;&quot;&quot;
    username = spawner.user.name
    DIR_NAME = os.path.join(&quot;/home&quot;, username)
    git_url = &quot;https://github.com/ProfessorKazarinoff/ENGR101.git&quot;
    repo_dir = os.path.join(DIR_NAME, 'notebooks')

    if ERASE_DIR == True:
        if os.path.isdir(repo_dir):
            shutil.rmtree(repo_dir)
        os.mkdir(repo_dir)
        clone_repo(username, git_url, repo_dir)

    if ERASE_DIR == False and not (os.path.isdir(repo_dir)):
        os.mkdir(repo_dir)
        clone_repo(username, git_url, repo_dir)

    if ERASE_DIR == False and os.path.isdir(repo_dir):
        pass

...

</code></pre>

<p>The two functions need to be pasted into the <code>jupyterhub_config.py file</code>. Make sure the imports are present as well as an <code>ERASE_DIR = True</code> or <code>ERASE_DIR = False</code> line in the <code>jupyterhub_config.py</code> file too.</p>
<h2 id="add-pre-spawn-hook-to-jupyterhub_configpy">Add pre-spawn hook to jupyterhub_config.py</h2>
<p>Next we need to add a pre-spawn hook function to the spawner object in our <code>jupyterhub_config.py</code> file in the form of:</p>
<pre><code class="python"># /etc/jupyterhub/jupyterhub_config.py
...

c.Spawner.pre_spawn_hook = create_dir_hook

...

</code></pre>

<h2 id="restart-jupyterhub">Restart JupyterHub</h2>
<p>With these changes complete, we can restart JupyterHub the commands:</p>
<pre><code>$ sudo systemctl stop jupyterhub
$ sudo systemctl start jupyterhub
$ sudo systemctl status jupyterhub
</code></pre>

<p>To exit the status screen, use [Ctrl] + [c].</p>
<p><br></p>
                
                  
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">
        
          <a href="../login_page/" title="Custom Login Page" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
            </div>
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                Custom Login Page
              </span>
            </div>
          </a>
        
        
          <a href="../useful_commands/" title="Usefull Commands" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                Usefull Commands
              </span>
            </div>
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
          <div class="md-footer-copyright__highlight">
            Copyright &copy; 2018 Peter D. Kazarinoff
          </div>
        
        powered by
        <a href="https://www.mkdocs.org">MkDocs</a>
        and
        <a href="https://squidfunk.github.io/mkdocs-material/">
          Material for MkDocs</a>
      </div>
      
        
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../assets/javascripts/application.5e60981f.js"></script>
      
      <script>app.initialize({version:"1.0.4",url:{base:".."}})</script>
      
    
    
      
    
  </body>
</html>